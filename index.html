<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#0f172a">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>SpotOps (Single-File)</title>
<style>
:root { color-scheme: light dark; }
* { box-sizing: border-box; }
body { font-family: -apple-system, system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin:0; background:#0b1020; color:#e5e7eb; }
header { padding:16px; background:#111827; position:sticky; top:0; z-index:10; }
h1 { font-size:18px; margin:0; }
main { padding:16px; padding-bottom:96px; }
.card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:12px; margin-bottom:12px; }
label { display:block; margin:8px 0 6px; font-size:14px; color:#cbd5e1; }
select, button, input[type="checkbox"] { font-size:16px; }
select, .btn, input[type="file"] { width:100%; padding:10px; border-radius:10px; border:1px solid #374151; background:#0b1224; color:#e5e7eb }
.btn-primary { background:#2563eb; border-color:#1d4ed8; }
.row { display:flex; gap:10px; }
.row > * { flex:1 }
.thumb { width:100%; max-height:260px; object-fit:contain; border-radius:8px; background:#0b1224; }
.muted { color:#9ca3af; font-size:12px; }
table { width:100%; border-collapse:collapse; }
th, td { text-align:left; padding:8px; border-bottom:1px solid #1f2937; font-size:14px; }
.tabs { display:flex; position:fixed; left:0; right:0; bottom:0; background:#0b1020; border-top:1px solid #1f2937; }
.tab { flex:1; text-align:center; padding:12px; color:#9ca3af; text-decoration:none; }
.tab.active { color:#e5e7eb; }
.notice { font-size:13px; color:#93c5fd; margin-top:8px; }
.danger { color:#fca5a5 }
.badge { font-size:11px; padding:2px 6px; border:1px solid #374151; border-radius:9999px; color:#cbd5e1; }
</style>
</head>
<body>
<header><h1>SpotOps</h1></header>
<main id="app"><noscript>This app needs JavaScript enabled.</noscript></main>
<nav class="tabs">
  <button class="tab" data-tab="submit">Submit</button>
  <button class="tab" data-tab="today">Today</button>
  <button class="tab" data-tab="me">Me</button>
</nav>

<script>
(function(){
  // Minimal state (localStorage)
  const KEY='spotops.sf.v1';
  function load(){ try{return JSON.parse(localStorage.getItem(KEY)||'{}')}catch{return{}} }
  function save(s){ localStorage.setItem(KEY, JSON.stringify(s)) }
  function dayKey(d=new Date()){ return new Date(d.toISOString().slice(0,10)).toISOString().slice(0,10) }
  function state(){
    const s=load();
    if(!s.me){ const animals=['Coyote','Viper','Falcon','Badger','Raven','Panther','Fox','Wolf','Hawk','Otter']; const n=Math.floor(Math.random()*89)+11; s.me={uid:crypto.randomUUID(), alias:animals[Math.floor(Math.random()*animals.length)]+n}; }
    if(!s.scores) s.scores={};
    if(!s.submissions) s.submissions=[];
    return s;
  }
  function addSubmission(sub){
    const s=state();
    s.submissions.push(sub);
    const d=sub.dayKey; s.scores[d]=s.scores[d]||{};
    s.scores[d][sub.uid]=(s.scores[d][sub.uid]||0)+sub.points;
    save(s);
  }
  function scoresToday(){
    const s=state(); const d=dayKey(); const day=s.scores[d]||{};
    return Object.entries(day).map(([uid,total])=>({uid,total})).sort((a,b)=>b.total-a.total);
  }

  const app=document.getElementById('app');
  const tabs=Array.from(document.querySelectorAll('.tab'));
  let current='submit';

  function setTab(t){ current=t; render(); }
  tabs.forEach(t=> t.addEventListener('click', ()=> setTab(t.dataset.tab)));

  const categories=[
    {key:'sign', label:'Military Sign (5)', points:5},
    {key:'vehicle', label:'Military Vehicle (10)', points:10},
    {key:'location', label:'Military Location (15)', points:15},
    {key:'uniform', label:'Uniform (Consent) (20)', points:20},
    {key:'uniform_face', label:'Uniform + Face (Consent) (50)', points:50},
  ];

  function render(){
    tabs.forEach(t=> t.classList.toggle('active', t.dataset.tab===current));
    app.innerHTML='';
    if(current==='submit') app.appendChild(viewSubmit(()=> setTab('today')));
    if(current==='today') app.appendChild(viewToday());
    if(current==='me') app.appendChild(viewMe());
  }

  function viewSubmit(onSubmitted){
    const wrap=document.createElement('div');
    wrap.innerHTML=`
      <div class="card">
        <label>Category</label>
        <select id="cat">${categories.map(c=>`<option value="${c.key}">${c.label}</option>`).join('')}</select>
        <label class="row" style="align-items:center;gap:8px;margin-top:8px">
          <input type="checkbox" id="consent"/> I have consent if a person is visible
        </label>
        <div class="card" id="previewBox">
          <img id="preview" class="thumb" alt="preview" />
          <div class="muted" id="status">No photo yet.</div>
        </div>
        <div class="row">
          <button class="btn btn-primary" id="shoot">Open Camera</button>
          <button class="btn" id="submit" disabled>Submit</button>
        </div>
        <div id="notice" class="notice"></div>
        <p class="muted">If consent is OFF, the image will be pixelated for safety.</p>
      </div>`;

    const file = document.createElement('input');
    file.type='file'; file.accept='image/*'; file.setAttribute('capture','environment'); file.style.display='none';
    wrap.appendChild(file);

    const catSel=wrap.querySelector('#cat');
    const consent=wrap.querySelector('#consent');
    const shoot=wrap.querySelector('#shoot');
    const submit=wrap.querySelector('#submit');
    const preview=wrap.querySelector('#preview');
    const status=wrap.querySelector('#status');
    const notice=wrap.querySelector('#notice');

    let imgBlob=null;

    shoot.addEventListener('click', ()=> file.click());
    file.addEventListener('change', async ()=>{
      const f=file.files[0]; if(!f) return;
      status.textContent='Processing...';
      const url=URL.createObjectURL(f);
      const img=await loadImg(url);
      const processed= await pixelateIfNoConsent(img, !consent.checked);
      imgBlob= await toBlob(processed, 'image/jpeg', 0.85);
      preview.src= URL.createObjectURL(imgBlob);
      status.textContent='Ready to submit';
      submit.disabled=false;
    });

    submit.addEventListener('click', async ()=>{
      if(!imgBlob) return;
      const s=state();
      const uid=s.me.uid;
      const c=categories.find(x=> x.key===catSel.value);
      const id=crypto.randomUUID();
      const dkey=dayKey();
      const points = (c.key==='uniform_face' && !consent.checked) ? 0 : c.points;
      addSubmission({id, uid, category:c.key, points, dayKey:dkey, createdAt: Date.now(), consent: consent.checked});
      imgBlob=null; preview.removeAttribute('src'); submit.disabled=true;
      notice.textContent='Submitted. +' + points + ' points' + (points===0?' (safety rule)':''); 
      if(onSubmitted) onSubmitted();
    });

    return wrap;
  }

  function viewToday(){
    const wrap=document.createElement('div');
    const data=scoresToday();
    wrap.innerHTML = '<div class="card"><table><thead><tr><th>User</th><th style="text-align:right">Points</th></tr></thead><tbody>'+
      (data.length? data.map(r=>`<tr><td>${mask(r.uid)}</td><td style="text-align:right">${r.total}</td></tr>`).join('') : '<tr><td colspan="2" class="muted">No entries yet today.</td></tr>')
      +'</tbody></table></div>';
    return wrap;
  }

  function viewMe(){
    const s=state();
    const wrap=document.createElement('div');
    wrap.innerHTML=`
      <div class="card">
        <div><span class="badge">Alias</span> ${s.me.alias}</div>
        <div style="margin-top:6px;"><span class="badge">UID</span> ${s.me.uid.slice(0,12)}…</div>
      </div>
      <div class="card">
        <button class="btn" id="reset">Reset local data</button>
        <p class="muted">Local MVP stores data on-device. Connect Supabase/Firebase to go global.</p>
        <p class="danger">Public spaces only. No harassment. Blur faces without consent.</p>
      </div>`;
    wrap.querySelector('#reset').addEventListener('click', ()=> { localStorage.removeItem(KEY); location.reload(); });
    return wrap;
  }

  // Helpers
  function mask(uid){ return uid.slice(0,6)+'…'; }
  function loadImg(src){ return new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src; }); }
  function toBlob(img, type='image/jpeg', quality=0.85){
    const c=document.createElement('canvas'); c.width=img.naturalWidth||img.width; c.height=img.naturalHeight||img.height;
    const x=c.getContext('2d'); x.drawImage(img,0,0);
    return new Promise(r=> c.toBlob(r, type, quality));
  }
  async function pixelateIfNoConsent(img, should){
    if(!should) return img;
    const w=img.naturalWidth||img.width, h=img.naturalHeight||img.height;
    const c=document.createElement('canvas'), t=document.createElement('canvas');
    c.width=w; c.height=h; t.width=Math.max(1, Math.floor(w*0.06)); t.height=Math.max(1, Math.floor(h*0.06));
    const x=c.getContext('2d'), tx=t.getContext('2d'); x.imageSmoothingEnabled=false; tx.imageSmoothingEnabled=false;
    tx.drawImage(img,0,0,t.width,t.height); x.drawImage(t,0,0,t.width,t.height,0,0,w,h);
    const out=new Image(); out.src=c.toDataURL('image/jpeg',0.85); await new Promise(r=> out.onload=r); return out;
  }

  // Simple error banner (helps debug on iPhone)
  window.addEventListener('error', (e)=>{
    const box=document.createElement('div');
    box.style.position='fixed'; box.style.bottom='60px'; box.style.left='0'; box.style.right='0';
    box.style.background='#7f1d1d'; box.style.color='#fecaca'; box.style.padding='8px'; box.style.fontSize='12px';
    box.style.borderTop='1px solid #dc2626'; box.style.zIndex='9999';
    box.textContent='JS error: ' + (e.message||e.error||'unknown');
    document.body.appendChild(box); setTimeout(()=> box.remove(), 5000);
  });

  // Boot
  render();

  // Register SW (relative path for GitHub Pages)
  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('./sw.js', { scope: './' }).catch(()=>{});
  }
})();
</script>
</body>
</html>
